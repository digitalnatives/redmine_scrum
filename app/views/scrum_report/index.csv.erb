"User Story", "Issue", "Assigne", "Status", "Estimated", <%= @report.csv_days.join(',') %>, "Total Spent", "Total Remaining"
<%= FCSV.generate do |csv|
  total_spent_hours = 0
  # subtotals by versions
  @report.issues.group_by(&:parent_id).each do |parent, tasks|
    user_story = Issue.find_by_id(parent)
    row = [ (user_story.present? ? user_story.subject : ''), '', '', '', tasks.sum(&:estimated_hours) ]
    @report.csv_days.each_slice(2) do |day|
      story_time_entries = tasks.map(&:time_entries).flatten.select{ |te| te.spent_on == day.first}
      tasks_day_hours = story_time_entries.sum(&:hours)
      tasks_day_remain = story_time_entries.sum(&:te_remaining_hours)
      row << (tasks_day_hours > 0 ?  tasks_day_hours : '')
      row << (tasks_day_remain > 0 ?  tasks_day_remain : '')
    end
    row << tasks.map(&:spent_time).compact.sum
    row << tasks.map(&:remaining_hours).sum
    csv << row
    # issues hours
    tasks.each do |task| 
      row = [ '', task.subject, task.assigned_to, task.status, task.estimated_hours ]
      @report.csv_days.each_slice(2) do |day|
        time_entries = task.time_entries.select{ |te| te.spent_on == day.first }.compact
        hours = time_entries.sum(&:hours)
        remain = time_entries.sum(&:te_remaining_hours)
        row << (hours > 0 ?  hours : '')
        row << (remain > 0 ? remain : '')
      end
      row << (task.spent_time.to_f > 0 ? task.spent_time : '')
      row << task.remaining_hours
      csv << row
    end
  end
  # totals
  row = [ 'Total', '', '', '' ]
  row << @report.issues.sum(&:estimated_hours)
  @report.csv_days.each_slice(2) do |day|
    daily_entries = @report.issues.map(&:time_entries).flatten.select{ |te| te.spent_on == day.first}
    daily_total = daily_entries.sum(&:hours)
    daily_remain = daily_entries.sum(&:te_remaining_hours)

    total_spent_hours += daily_total
    row << (daily_total > 0 ? daily_total : '')
    row << (daily_remain > 0 ? daily_remain : '')
  end
  row << (total_spent_hours > 0 ? total_spent_hours : '')
  row << @report.issues.sum(&:remaining_hours)
  csv << row
end.html_safe %>

